<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Backend Control Panel</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .control-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        select, button { padding: 8px; width: 100%; max-width: 300px; }
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 15px; }
        .perm-card { border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #fafafa; }
        .perm-card.active { background: #e3f2fd; border-color: #2196f3; }
        .btn-save { background: #28a745; color: white; border: none; cursor: pointer; margin-top: 20px; font-size: 16px; }
        .btn-save:hover { background: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ†Ô∏è Panel de Control de Seguridad</h1>
    
    <div class="control-group">
        <label>Seleccionar Perfil a Editar:</label>
        <select id="profileSelect" onchange="loadPermissions()">
            <option value="">Cargando perfiles...</option>
        </select>
    </div>

    <div id="loading" style="display:none;">Cargando datos...</div>

    <div id="permissionsContainer" style="display:none;">
        <h3>Gestionar Permisos (M√©todos)</h3>
        <div class="permissions-grid" id="methodsGrid">
            </div>
        <button class="btn-save" onclick="saveChanges()">Guardar Cambios</button>
    </div>
</div>

<script>
    // URL de tu endpoint √∫nico
    const API_URL = '/ToProcess'; 
    let currentPermissions = [];
    let allMethods = [];

    // Funci√≥n gen√©rica para llamar a ToProcess
    async function callBackend(object, method, params = {}) {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ objectName: object, methodName: method, params: params })
        });
        return await response.json();
    }

    async function init() {
        // 1. Cargar Perfiles usando ProfileBO
        const res = await callBackend('ProfileBO', 'getProfiles');
        if(res.sts) {
            const select = document.getElementById('profileSelect');
            select.innerHTML = '<option value="">Seleccione un perfil</option>';
            res.data.forEach(p => {
                select.innerHTML += `<option value="${p.id_profile}">${p.profile}</option>`;
            });
        }
        
        // 2. Cargar Todos los M√©todos Disponibles usando MethodBO
        const methodsRes = await callBackend('MethodBO', 'getMethods');
        if(methodsRes.sts) allMethods = methodsRes.data;
    }

    async function loadPermissions() {
        const profileId = document.getElementById('profileSelect').value;
        if(!profileId) return;

        // Obtener permisos actuales de la base de datos (Security.js o una query custom)
        // Nota: Asumimos que tienes un m√©todo para listar permisos por perfil.
        // Si no, usamos getPermissionMethods y filtramos en cliente (menos eficiente pero funciona para admin)
        const permRes = await callBackend('MethodBO', 'getPermissionMethods');
        
        const grid = document.getElementById('methodsGrid');
        grid.innerHTML = '';
        
        if(permRes.sts) {
            // Filtrar permisos solo para este perfil
            const activePerms = permRes.data.filter(p => p.fk_id_profile == profileId);
            const activeMethodIds = activePerms.map(p => p.fk_id_method);

            allMethods.forEach(method => {
                const isActive = activeMethodIds.includes(method.id_method);
                const div = document.createElement('div');
                div.className = `perm-card ${isActive ? 'active' : ''}`;
                div.innerHTML = `
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" 
                               value="${method.id_method}" 
                               ${isActive ? 'checked' : ''} 
                               style="width:auto; margin-right:10px;">
                        <div>
                            <strong>${method.object}</strong><br>
                            <small>${method.method}</small>
                        </div>
                    </label>
                `;
                grid.appendChild(div);
            });
            
            document.getElementById('permissionsContainer').style.display = 'block';
        }
    }

    async function saveChanges() {
        const profileId = document.getElementById('profileSelect').value;
        if(!profileId) return alert("Seleccione un perfil");

        // Recolectar IDs seleccionados
        const checkboxes = document.querySelectorAll('#methodsGrid input[type="checkbox"]');
        const selectedMethods = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

        // L√≥gica simplificada: En un entorno real, calcular√≠as el "delta" (qu√© borrar, qu√© agregar).
        // Aqu√≠ podr√≠as hacer un "bulk update" creando un m√©todo nuevo en MethodBO 
        // o llamando a createPermissionMethod / deletePermissionMethods uno por uno.
        
        alert(`L√≥gica de guardado pendiente de implementar en MethodBO.\nSe intentar√° asignar ${selectedMethods.length} m√©todos al perfil ${profileId}.`);
        
        // Ejemplo de llamada para crear uno (iterar en un bucle o crear un endpoint masivo):
        // await callBackend('MethodBO', 'createPermissionMethod', { 
        //    fk_id_profile: profileId, fk_id_method: selectedMethods[0], ... 
        // });
    }

    // Iniciar al cargar
    init();
</script>
</body>
</html>